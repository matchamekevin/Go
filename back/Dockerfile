FROM node:20-alpine AS builder
WORKDIR /usr/s# CrÃ©er un script de dÃ©marrage simplifiÃ© (sans scripts d'initialisation)
RUN echo '#!/bin/sh\n\
echo "ðŸš€ DÃ©marrage simplifiÃ© de l'\''application SOTRAL..."\n\
echo "ðŸ“‚ RÃ©pertoire actuel: $(pwd)"\n\
echo "ðŸ” Contenu du rÃ©pertoire:"\n\
ls -la /usr/src/app/\n\
echo "âœ… DÃ©marrage direct du serveur..."\n\
exec node dist/server.js' > /usr/src/app/start-simple.sh && \
    chmod +x /usr/src/app/start-simple.sh && \
    echo "Script start-simple.sh crÃ©Ã©:" && \
    cat /usr/src/app/start-simple.sh && \
    echo "VÃ©rification finale:" && \
    ls -la /usr/src/app/start-simple.sh && \
    test -x /usr/src/app/start-simple.sh && echo "âœ… Script exÃ©cutable" || echo "âŒ Script non exÃ©cutable" Copier manifests pour cache layer npm
COPY package*.json ./
# Install deps (dev inclus pour compilation TypeScript) via lockfile
RUN npm ci

# Copier le reste du code
COPY . .

# Build TypeScript -> dist
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /usr/src/app

# Installer PostgreSQL client pour l'initialisation
RUN apk add --no-cache postgresql-client

# DÃ©finir env prod tÃ´t
ENV NODE_ENV=production

# Copier manifests (lock assure versions dÃ©terministes)
COPY --from=builder /usr/src/app/package*.json ./

# Installer uniquement deps de prod (npm v10 supporte --omit=dev)
RUN npm ci --omit=dev

# Copier le build compilÃ©
COPY --from=builder /usr/src/app/dist ./dist

# Copier les scripts d'initialisation avec chemins absolus
COPY --from=builder /usr/src/app/init-sotral.sh /usr/src/app/init-sotral.sh
COPY --from=builder /usr/src/app/init-sotral-manual.sh /usr/src/app/init-sotral-manual.sh
COPY --from=builder /usr/src/app/diagnose-sotral.sh /usr/src/app/diagnose-sotral.sh
COPY --from=builder /usr/src/app/insert-stops.sh /usr/src/app/insert-stops.sh
COPY --from=builder /usr/src/app/src/schema /usr/src/app/src/schema

# Rendre le script exÃ©cutable et vÃ©rifier
RUN chmod +x /usr/src/app/*.sh && \
    ls -la /usr/src/app/*.sh && \
    echo "Scripts disponibles:" && \
    find /usr/src/app -name "*.sh" -type f -executable

# CrÃ©er un script de dÃ©marrage simplifiÃ© (sans scripts d'initialisation)
RUN echo '#!/bin/sh\n\
echo "ðŸš€ DÃ©marrage simplifiÃ© de l'\''application SOTRAL..."\n\
echo "ðŸ“‚ RÃ©pertoire actuel: $(pwd)"\n\
echo "ï¿½ Contenu du rÃ©pertoire:"\n\
ls -la /usr/src/app/\n\
echo "âœ… DÃ©marrage direct du serveur..."\n\
exec node dist/server.js' > /usr/src/app/start-simple.sh && \
    chmod +x /usr/src/app/start-simple.sh

# Healthcheck interne (utilise fetch natif Node 20, sans curl)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 CMD node -e "fetch('http://localhost:7000/health').then(r=>process.exit(r.status===200?0:1)).catch(()=>process.exit(1))"

EXPOSE 7000
# DÃ©marrage direct sans script shell (plus fiable)
CMD ["node", "dist/server.js"]
